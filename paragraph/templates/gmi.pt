<c tal:define='main load:main.pt' metal:use-macro="main">
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <title metal:fill-slot="title">Query</title>
        <span tal:omit-tag="" metal:fill-slot="headslot">
            <script src="${flask.url_for('static', filename='codemirror.js')}"></script>
            <link rel="stylesheet" href="${flask.url_for('static', filename='codemirror.css')}">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.4.6/dist/css/uikit.min.css" />

            <script src="${flask.url_for('static', filename='python.js')}"></script>
            <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.0/dist/mermaid.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/uikit@3.4.6/dist/js/uikit.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/uikit@3.4.6/dist/js/uikit-icons.min.js"></script>
             <script src="//unpkg.com/three"></script>
            <script src="//unpkg.com/three-spritetext"></script>
            <script src="//unpkg.com/3d-force-graph"></script>

            <style>
                .CodeMirror{border: 1px solid black;
                            height: 10em;
                            width: 50vw;
                            resize: vertical;
                }
                .code { counter-reset: listing;
                        border: 1px dashed grey;
                        padding: 2px;
                        width: 100%;}
                code { counter-increment: listing; }
                .code code:before {
                    content: counter(listing) "";
                    color: #AAAAAA;
                    display: inline-block;
                    min-width: 2em;
                    background-color: #F7F7F7;
                    border-right: 1px solid #DDDDDD;
                    text-align: right;
                    margin-right: 0.5em;
                   }
                .error {border: 1px dashed red}

                .uk-tooltip {
                    word-wrap: break-word;
                    max-width:100%;
                }

                .basetable td,tr {
                    padding: 15px;
                }

                .spacer {
                    width: 2em;
                    display: inline-block;
                }

                .delete-checkbox {
                    width: 2em;
                    display: inline-block;
                }

                .linktable td {
                    padding: 0px;
                }
                body {
                    font-size: 0.9em;
                }

            </style>


        </span>
    </head>
    <body>

    <span metal:fill-slot="content" tal:omit-tag="">
    <span metal:define-macro="ajax" tal:omit-tag="">
<table border="0" class="basetable">
    <tr valign="top">
        <td>
            <h2>Query</h2>
            <form action="/gmi" id='codeform' class="uk-form">
                <input type='hidden' name='lastline' id='lastline'>
                <input type='hidden' name='lastch' id='lastch'>
                <textarea id="codeeditor" name="statement" cols="60" rows="5"
                     tal:define="statement request.values.get('statement')"
                     tal:content="statement and statement or default">#result = db.traverse().oN()
result = db.query('match (n)-[r*1..2]->(m) return n, "foo", r, m')
for row in result.rows:
    print(row['n'].get('name',row['n'].id[:6]))
print('\nnow continue working with the result')
print(result.rows[0]['n'].oN().nodes)
    </textarea><br>
                <input type="submit" class="uk-button uk-button-primary" value="run (ctrl+enter)"></input>

            </form>

            <div class="uk-text-right"><a onClick="add_node();return false;">Add node</a></div>
            <div class="uk-text-right"><a onClick="show_detail('/add_edge');return false;">Add edge</a></div>

            <span tal:condition="0">
                <span metal:define-macro="nodelink">
                    <a href="/edit_node/${node.id}"
                       onclick="show_detail($(this).attr('href')); return false;"
                       class="node${node.id}"
                       title="Node ${node.id}">
                        <span tal:omit-tag=""
                              metal:define-macro="nodelinktext">${node.labels and ', '.join(sorted(list(node.labels))) or 'Node'} ${node.dn()}</span></a>
                </span>
                <span metal:define-macro="edgelink">
                    <span tal:define="node edge.source" metal:use-macro="macros.nodelink" tal:omit-tag="">nodeA</span>
                    &nbsp;
                    <a  href="/edit_edge/${edge.id}"
                        onclick="show_detail($(this).attr('href')); return false;"
                        class="edge${edge.id}"
                        title="Edge ${edge.id}"
                        metal:define-macro="edgelinka">
                        --[${edge.reltype}] -->
                    </a>
                    &nbsp;
                    <span tal:define="node edge.target" metal:use-macro="macros.nodelink" tal:omit-tag="">nodeB</span>
                </span>
            </span>

            <div>&nbsp</div>
            <ul class="uk-subnav" uk-tab>
                <li><a href="#">List</a></li>
                <li><a href="#">Graph</a></li>
                <li><a href="#">3D</a></li>
                <li><a href="#">Table</a></li>
                <li><a href="#">Printed</a></li>
            </ul>
            <div class="uk-switcher">

                <div>
                    <div>
                        <b>Nodes</b>

                        <ul class="uk-list uk-list-bullet">
                            <li tal:repeat="node result.nodes" tal:attributes="class 'node'+node.id">
                                <span metal:use-macro="macros.nodelink"></span>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <b>Edges</b>

                        <ul class="uk-list uk-list-bullet">
                            <li tal:repeat="edge result.edges">
                                 <span metal:use-macro="macros.edgelink"></span>
                            </li>
                        </ul>
                    </div>
                </div>

                 <div onshow="mermaid.init({securityLevel:'loose'},'.mermaid')">
                    <div><b>Graph</b></div>
                    <div>&nbsp;</div>
                     <div class="mermaid" tal:condition="result.nodes or result.edges">
                      graph TD
                         <span tal:omit-tag="" tal:repeat="node result.allnodes().nodes">n${node.id}(${', '.join(list(node.labels))} <br/>${node.get("name",node.id[:6])})</span>
                         <span tal:omit-tag="" tal:repeat="edge result.edges">n${edge.source.id}-- ${edge.reltype}-->n${edge.target.id}</span>
                         <span tal:omit-tag="" tal:repeat="node result.allnodes().nodes">click n${node.id} node_callback</span>
                      </div>
                </div>
                <div xonshow="start_3d()">
                    <span id="3d-graph-data" style="display:none">
                        ${result.graphjson()}
                    </span>
                    <div id="3d-graph">3d</div>

                </div>


                <div class="uk-overflow-auto">
                    <div><b>Data</b></div>
                    <div>&nbsp;</div>

                    <table tal:condition="result.rows" xborder="1"
                                                       class="uk-table uk-table-striped uk-table-hover uk-table-responsive"
                                                       xstyle="width:40em">
                        <thead>
                            <tr>
                               <th tal:repeat="key result.rows[0].keys()" tal:content="key"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr tal:repeat="row result.rows">
                                <td tal:repeat="key row.keys()" tal:content="row[key]"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div>
                    <div><b>Printed</b></div>
                    <pre style="">${printvalue}</pre>
                </div>
            </div>
        </td>
        <td style="border-left: 0.5px solid darkgrey; min-height: 50vh; max-height: 50vh; min-width: 100%">
            <div id="action"></div>

        </td>

    </tr>
</table>
<div id="samplediv" style="height:0;width:0;outline:none;border:none;padding:none;margin:none;box-sizing:content-box;"></div>
  <c tal:condition="request.values.get('lastline')"
             tal:replace="structure string:<script>var lastline=${request.values.get('lastline',0)};var lastch=${request.values.get('lastch',0)};</script>" />
        <script>
            var codeeditor = document.getElementById("codeeditor");
            var doc = CodeMirror.fromTextArea(codeeditor, {
                'mode': 'python',
                'autofocus': true,
                'indentUnit': 4,
                'lineNumbers': 1,
            });
            doc.setCursor(parseInt(lastline) | 0, parseInt(lastch) | 0);

            function storePos() {
                pos = doc.getCursor();
                document.getElementById('lastline').value = pos.line;
                document.getElementById('lastch').value = pos.ch;

            }

            doc.addKeyMap({
                "Ctrl-Enter": function (cm) {
                    storePos();
                    document.forms['codeform'].submit();
                }
            })

            document.forms['codeform'].onsubmit = function () {
                storePos();
            }
            mermaid.initialize({startOnLoad: false,securityLevel:'loose'});

            function show_detail(path){
                $.get(path, function (data) {
                    $('#action').html(data);
                })
            }

            // for mermaid
            var node_callback = function(idstring) {
                var node_id = idstring.substr(1);
                var path = '/edit_node/'+node_id;
                show_detail(path);

            }

            var node_3d_callback = function (node,event) {
                var path = '/edit_node/'+node.id;
                show_detail(path);
            }

            var div = document.getElementById('samplediv');
            div.style.height = '1em';
            var em = div.offsetHeight;


            var start_3d = function() {
                var myGraph = ForceGraph3D({ controlType: 'orbit' });
                var canvas = document.getElementById('3d-graph');
                var data = JSON.parse($('#3d-graph-data').text());

                console.log(data);
                mg = myGraph(canvas);
                console.log(em);
                mg.height(40*em);
                mg.width(50*em);
                mg.cooldownTicks(100);
                mg.backgroundColor('#FFFFFF')

                mg.graphData(data);
                mg.nodeAutoColorBy('name');
                mg.nodeThreeObject(node => {
                  // use a sphere as a drag handle
                  const obj = new THREE.Mesh(
                    new THREE.SphereGeometry(10),
                    new THREE.MeshBasicMaterial({ depthWrite: false, transparent: true, opacity: 0 })
                  );

                  // add text sprite as child
                  const sprite = new SpriteText(node.name);
                  sprite.color = node.color;
                  sprite.textHeight = 6;
                  obj.add(sprite);

                  return obj;
                });
                mg.onNodeClick(node_3d_callback);
                mg.onNodeHover(function(){});
                mg.linkThreeObjectExtend(true);
                mg.linkThreeObject(link => {
                  // extend link with text sprite
                  const sprite = new SpriteText(`$$${link.reltype}`);
                  sprite.color = 'darkgrey';
                  sprite.textHeight = 3.5;
                  return sprite;
                })
                .linkPositionUpdate((sprite, { start, end }) => {
                  const middlePos = Object.assign(...['x', 'y', 'z'].map(c => ({
                    [c]: start[c] + (end[c] - start[c]) / 2 // calc middle point
                  })));

                  // Position sprite
                  Object.assign(sprite.position, middlePos);
                });
                //mg.linkDirectionalParticles(5);
                mg.d3Force('charge').strength(-120);
                mg
                    //.linkWidth(1)
                    .linkCurvature(0)
                    .linkDirectionalArrowLength(3.5)
                    .linkDirectionalArrowRelPos(1)
                    .linkDirectionalArrowColor(function(link){return "lightgrey"})
                    .linkColor(function(link){return "darkgrey"})
                    //.linkAutoColorBy('reltype')
                    .linkOpacity(0.3)
                ;
                mg.onEngineStop(() => mg.zoomToFit(400));
            }

            var add_node = function() {
                $.get('/add_node',function(data) {
                    //location.reload();
                    var node_id = data;
                    node_callback('n'+node_id);
                })
            }

            start_3d();
        </script>
            </span>
</span>
    </body>
    </html>
</c>